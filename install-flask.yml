---
- name: Deploy Flask web app
  hosts: all
  become: yes
  vars:
    app_directory: "/home/{{ ansible_user }}/flask-app"
    git_repo_url: "https://github.com/ctoweh/flask_web_app.git"

  tasks:
    - name: Install git
      package:
        name: git
        state: present
      when: ansible_distribution == "Amazon" or ansible_distribution == "Ubuntu"

    - name: Install git on CentOS using dnf
      dnf:
        name: git
        state: present
      when: ansible_distribution == "CentOS"

    - name: Create flask-app directory
      file:
        path: "{{ app_directory }}"
        state: directory
        mode: "0755"

    - name: Clone GitHub repository
      git:
        repo: "{{ git_repo_url }}"
        dest: "{{ app_directory }}/repository"
        update: yes

    - name: Update repositories and install Python
      package:
        name: "{{ item }}"
        state: present
      loop:
        - python3
      when: ansible_distribution == "Amazon" or ansible_distribution == "CentOS" or ansible_distribution == "Ubuntu"

    - name: Install pip
      get_url:
        url: https://bootstrap.pypa.io/get-pip.py
        dest: /tmp/get-pip.py
      become: yes
      become_user: root
      args:
        creates: /usr/local/bin/pip
      when: ansible_distribution == "Amazon" or ansible_distribution == "CentOS" or ansible_distribution == "Ubuntu"

    - name: Install virtualenv package
      pip:
        name: virtualenv
        state: present
      when: ansible_distribution == "Amazon" or ansible_distribution == "CentOS" or ansible_distribution == "Ubuntu"

    - name: Create virtual environment
      command: python3 -m venv {{ app_directory }}/venv
      args:
        creates: "{{ app_directory }}/venv"

    - name: Activate virtual environment
      command: "source {{ app_directory }}/venv/bin/activate && python --version"
      args:
        executable: /bin/bash
      become: yes
      become_user: "{{ ansible_user }}"

    - name: Install Flask within virtual environment
      pip:
        name: flask
        executable: pip3
        state: present

    - name: Run Flask app
      command: python {{ app_directory }}/repository/app.py &
      async: 60
      poll: 0
      register: flask_app_process

    - name: Wait for Flask app to run
      async_status:
        jid: "{{ flask_app_process.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 6
      delay: 10

    - name: Get PID of Flask app
      shell: pgrep -f "python {{ app_directory }}/repository/app.py"
      register: flask_app_pid

    - name: Stop Flask app
      shell: kill -9 "{{ flask_app_pid.stdout }}"
      ignore_errors: true
